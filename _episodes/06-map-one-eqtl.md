---
# Please do not edit this file directly; it is auto generated.
# Instead, please edit 06-map-one-eqtl.md in _episodes_rmd/
title: "Mapping a Gene Expression Trait"
teaching: 30
exercises: 30
questions:
- "How do I map one gene expression trait?"
objectives:
- "????"
keypoints:
- "????"
source: Rmd
---



### Load Libraries  


~~~
library(tidyverse)
library(qtl2)
library(qtl2convert)
#library(qtl2db)
library(GGally)
library(broom)
library(corrplot)
library(RColorBrewer)
library(knitr)
~~~
{: .language-r}

## Load Data


~~~
#expression data
load("../data/attie_DO500_expr.datasets.RData")

##mapping data
load("../data/attie_DO500_mapping.data.RData")

genoprobs <- readRDS("../data/attie_DO500_genoprobs_qtlviewer_8state_69k.rds")
~~~
{: .language-r}



~~~
Warning in gzfile(file, "rb"): cannot open compressed file '../data/
attie_DO500_genoprobs_qtlviewer_8state_69k.rds', probable reason 'No such file
or directory'
~~~
{: .warning}



~~~
Error in gzfile(file, "rb"): cannot open the connection
~~~
{: .error}



~~~
##phenotypes
load("../data/attie_DO500_clinical.phenotypes.RData")
~~~
{: .language-r}

### Expression Data


Lets check the distribution



~~~
hist(counts$ENSMUSG00000020679, main = "Hnf1b")
~~~
{: .language-r}

<img src="../fig/rmd-06-hist_untransformed-1.png" alt="plot of chunk hist_untransformed" width="612" style="display: block; margin: auto;" />

These counts are normalised

### The Marker Map  

The marker map for each chromosome is stored in the `map` object. This is used to plot the LOD scores calculated at each marker during QTL mapping.  Here we are using the 69K grid marker file



### Genotype probabilities  

We have already claculated genotype probabilities which we load above


~~~
probs = genoprobs
~~~
{: .language-r}



~~~
Error in eval(expr, envir, enclos): object 'genoprobs' not found
~~~
{: .error}


~~~
dim(probs[[1]])
~~~
{: .language-r}



~~~
Error in eval(expr, envir, enclos): object 'probs' not found
~~~
{: .error}


~~~
plot_genoprob(probs, map, ind = 1, chr = 1)
~~~
{: .language-r}



~~~
Error in plot_genoprob(probs, map, ind = 1, chr = 1): object 'probs' not found
~~~
{: .error}

### [Kinship Matrix](https://smcclatchy.github.io/mapping/04-calc-kinship/)

The kinship matrix has already been calculated and loaded in above



~~~
n_samples <- 50

heatmap(K[[1]][1:n_samples, 1:n_samples])
~~~
{: .language-r}

<img src="../fig/rmd-06-kinship_probs-1.png" alt="plot of chunk kinship_probs" width="576" style="display: block; margin: auto;" />

### Covariates    

Now lets add the necessary covariates. For these analysis, lets see which covariates are significant (???)


~~~
# convert sex and DO wave (batch) to factors
pheno_clin$sex = factor(pheno_clin$sex)
pheno_clin$DOwave = factor(pheno_clin$DOwave)

covar = model.matrix(~sex + DOwave, data = pheno_clin)
~~~
{: .language-r}
### [Performing a genome scan](https://smcclatchy.github.io/mapping/06-perform-genome-scan/) 

Now lets perform the genome scan!


~~~
qtl = scan1(genoprobs = probs, pheno = counts[,"ENSMUSG00000020679", drop = FALSE], kinship = K, addcovar = covar, cores = 2)
~~~
{: .language-r}



~~~
Error in scan1(genoprobs = probs, pheno = counts[, "ENSMUSG00000020679", : object 'probs' not found
~~~
{: .error}

Lets plot it



~~~
plot_scan1(x = qtl, map = map, lodcolumn = "ENSMUSG00000020679", main = colnames(qtl))
~~~
{: .language-r}



~~~
Error in plot_scan1(x = qtl, map = map, lodcolumn = "ENSMUSG00000020679", : object 'qtl' not found
~~~
{: .error}



~~~
  abline(h = 6, col = 2, lwd = 2)
~~~
{: .language-r}



~~~
Error in int_abline(a = a, b = b, h = h, v = v, untf = untf, ...): plot.new has not been called yet
~~~
{: .error}

### [Performing a permutation test](https://smcclatchy.github.io/mapping/10-perform-perm-test/) 

Not in scripts

### [Finding LOD peaks](https://smcclatchy.github.io/mapping/07-find-lod-peaks/)

Lets find LOD peaks


~~~
lod_threshold = 6
peaks = find_peaks(scan1_output = qtl, map = map, threshold = lod_threshold, peakdrop = 4, prob = 0.95)
~~~
{: .language-r}



~~~
Error in align_scan1_map(scan1_output, map): object 'qtl' not found
~~~
{: .error}



~~~
kable(peaks %>% 
        dplyr::select(-lodindex) %>% 
        arrange(chr, pos), caption = "Phenotype QTL Peaks with LOD >= 6")
~~~
{: .language-r}



~~~
Error in dplyr::select(., -lodindex): object 'peaks' not found
~~~
{: .error}

Lets plot them:

should we?

### [Estimated QTL effects](https://smcclatchy.github.io/mapping/11-est-qtl-effects/) 

Not in scripts


### [SNP Association Mapping](https://smcclatchy.github.io/mapping/12-snp-assoc/)

Not in scripts

### Searching for Candidate Genes

Not in scripts
